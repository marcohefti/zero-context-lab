name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Resolve Version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            tag="${{ inputs.tag }}"
          else
            tag="${{ github.ref_name }}"
          fi
          if [[ ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "invalid tag: $tag (expected vX.Y.Z...)" >&2
            exit 2
          fi
          version="${tag#v}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Build Release Artifacts
        env:
          VERSION: ${{ steps.ver.outputs.tag }}
        run: ./scripts/release-build.sh

      - name: Release Check
        env:
          VERSION: ${{ steps.ver.outputs.tag }}
        run: ./scripts/release-check.sh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          generate_release_notes: true
          files: |
            artifacts/release/${{ steps.ver.outputs.tag }}/zcl_*
            artifacts/release/${{ steps.ver.outputs.tag }}/SHA256SUMS

      - name: Update Homebrew Formula (stable)
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.ver.outputs.tag }}"
          version="${{ steps.ver.outputs.version }}"

          url="https://codeload.github.com/marcohefti/zero-context-lab/tar.gz/refs/tags/${tag}"
          tmp="$(mktemp)"
          curl -fsSL "$url" -o "$tmp"

          if command -v shasum >/dev/null 2>&1; then
            sha="$(shasum -a 256 "$tmp" | awk '{print $1}')"
          elif command -v sha256sum >/dev/null 2>&1; then
            sha="$(sha256sum "$tmp" | awk '{print $1}')"
          else
            sha="$(openssl dgst -sha256 "$tmp" | awk '{print $2}')"
          fi

          ./scripts/brew-formula-write.sh --version "$version" --sha256 "$sha"

      - name: Commit Formula Update
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet -- Formula/zcl.rb; then
            echo "formula unchanged"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/zcl.rb
          git commit -m "chore(brew): bump zcl formula to ${{ steps.ver.outputs.tag }}"
          git push
