# Canonical campaign template for paired benchmarking.
#
# Supported by current ZCL parser/executor:
# - schemaVersion, campaignId, outRoot
# - promptMode (default|mission_only), noContext.forbiddenPromptTerms
# - totalMissions, canaryMissions, failFast
# - missionSource.path + missionSource.selection (all|mission_id|index|range)
# - execution.flowMode (sequence|parallel)
# - pairGate.enabled, pairGate.stopOnFirstMissionFailure, pairGate.traceProfile (or flowGate alias)
# - semantic.enabled, semantic.rulesPath
# - cleanup.beforeMission/afterMission/onFailure (executed with bounded timeout)
# - timeouts.campaignGlobalTimeoutMs/defaultAttemptTimeoutMs/cleanupHookTimeoutMs/timeoutStart
# - output.reportPath/summaryPath/resultsMdPath/publishCheck/progressJsonl
# - invalidRunPolicy.statuses/publishRequiresValid/forceFlag
# - flows[].flowId, flows[].runner.* (suiteFile optional when missionSource.path is set)
# - flows[].promptSource.path (per-flow mission source override when suiteFile omitted)
# - flows[].promptTemplate.path + allowRunnerEnvKeys (flow-aware template materialization)
# - flows[].toolPolicy.allow/deny/aliases (hard tool namespace/prefix isolation)
# - flows[].runner.model/modelReasoningEffort/modelReasoningPolicy (codex_app_server only)
# - flows[].runner.toolDriver.kind/shims
# - flows[].runner.finalization.mode/minResultTurn/resultChannel
# - flows[].adapterContract.requiredOutputFields (must include attemptDir/status/errors)
schemaVersion: 1
campaignId: tool-comparison
outRoot: .zcl
promptMode: default

totalMissions: 0
canaryMissions: 3
failFast: true

missionSource:
  path: ./missions
  selection:
    mode: range
    missionIds: []
    indexes: []
    range:
      start: 5
      end: 8

execution:
  flowMode: sequence

pairGate:
  enabled: true
  stopOnFirstMissionFailure: true
  traceProfile: strict_browser_comparison

semantic:
  enabled: true
  rulesPath: ./semantic.rulepack.yaml

noContext:
  forbiddenPromptTerms:
    - "zcl run"
    - "zcl mcp proxy"
    - "zcl feedback"

cleanup:
  beforeMission:
    - "pkill -f 'zcl mcp proxy' || true"
    - "rm -rf ./.zcl/tmp/* || true"
  afterMission:
    - "pkill -f 'zcl mcp proxy' || true"
  onFailure:
    - "pkill -f 'zcl mcp proxy' || true"

timeouts:
  campaignGlobalTimeoutMs: 7200000
  defaultAttemptTimeoutMs: 180000
  cleanupHookTimeoutMs: 15000
  timeoutStart: first_tool_call

output:
  reportPath: .zcl/campaigns/tool-comparison/campaign.report.json
  summaryPath: .zcl/campaigns/tool-comparison/campaign.summary.json
  resultsMdPath: .zcl/campaigns/tool-comparison/RESULTS.md
  publishCheck: required
  progressJsonl: .zcl/campaigns/tool-comparison/campaign.progress.jsonl

invalidRunPolicy:
  statuses: ["valid", "invalid", "aborted"]
  publishRequiresValid: true
  forceFlag: --force

flows:
  - flowId: flow-a
    # Optional per-flow prompt controls for mission-pack mode:
    # promptSource:
    #   path: ./missions/flow-a
    # promptTemplate:
    #   path: ./prompts/flow-a.template.txt
    #   allowRunnerEnvKeys: ["ZCL_MIN_VERSION"]
    # toolPolicy:
    #   allow:
    #     - namespace: cli
    #       prefix: tool-cli
    #   deny:
    #     - namespace: mcp
    #   aliases:
    #     chrome: ["chrome-devtools__", "chrome-mcp__"]
    runner:
      type: codex_exec
      command: ["codex", "exec", "--", "./scripts/run_flow_a.sh"]
      sessionIsolation: process
      feedbackPolicy: auto_fail
      mode: discovery
      timeoutMs: 180000
      timeoutStart: first_tool_call
      strict: true
      strictExpect: true
      freshAgentPerAttempt: true
      toolDriver:
        kind: cli_funnel
        shims: ["tool-cli"]
      finalization:
        mode: auto_fail
        resultChannel:
          kind: none
      mcp:
        maxToolCalls: 60
        idleTimeoutMs: 30000
        shutdownOnComplete: true
      env:
        ZCL_MIN_VERSION: "0.0.0-dev"
    adapterContract:
      requiredOutputFields: ["attemptDir", "status", "errors"]

  - flowId: flow-b
    runner:
      type: claude_subagent
      command: ["claude", "--", "./scripts/run_flow_b.sh"]
      sessionIsolation: process
      feedbackPolicy: auto_fail
      mode: discovery
      timeoutMs: 180000
      timeoutStart: first_tool_call
      strict: true
      strictExpect: true
      freshAgentPerAttempt: true
      toolDriver:
        kind: cli_funnel
        shims: ["tool-cli"]
      finalization:
        mode: auto_fail
        resultChannel:
          kind: none
      mcp:
        maxToolCalls: 60
        idleTimeoutMs: 30000
        shutdownOnComplete: true
      env:
        ZCL_MIN_VERSION: "0.0.0-dev"
    adapterContract:
      requiredOutputFields: ["attemptDir", "status", "errors"]
