{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://zcl.dev/schema/campaign.spec.v1.json",
  "title": "ZCL Campaign Spec v1",
  "type": "object",
  "required": ["campaignId", "flows"],
  "properties": {
    "schemaVersion": { "type": "integer", "enum": [1] },
    "campaignId": { "type": "string", "minLength": 1 },
    "outRoot": { "type": "string" },
    "promptMode": { "type": "string", "enum": ["default", "mission_only", "exam"] },
    "totalMissions": { "type": "integer", "minimum": 0 },
    "canaryMissions": { "type": "integer", "minimum": 0 },
    "failFast": { "type": "boolean" },
    "missionSource": {
      "type": "object",
      "properties": {
        "path": { "type": "string" },
        "promptSource": {
          "type": "object",
          "properties": {
            "path": { "type": "string" }
          },
          "additionalProperties": false
        },
        "oracleSource": {
          "type": "object",
          "properties": {
            "path": { "type": "string" },
            "visibility": { "type": "string", "enum": ["workspace", "host_only"] }
          },
          "additionalProperties": false
        },
        "selection": {
          "type": "object",
          "properties": {
            "mode": { "type": "string", "enum": ["all", "mission_id", "index", "range"] },
            "missionIds": { "type": "array", "items": { "type": "string" } },
            "indexes": { "type": "array", "items": { "type": "integer", "minimum": 0 } },
            "range": {
              "type": "object",
              "properties": {
                "start": { "type": "integer", "minimum": 0 },
                "end": { "type": "integer", "minimum": 0 }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "evaluation": {
      "type": "object",
      "properties": {
        "mode": { "type": "string", "enum": ["none", "oracle"] },
        "evaluator": {
          "type": "object",
          "properties": {
            "kind": { "type": "string", "enum": ["script", "builtin_rules"] },
            "command": { "type": "array", "minItems": 1, "items": { "type": "string" } }
          },
          "additionalProperties": false
        },
        "oraclePolicy": {
          "type": "object",
          "properties": {
            "mode": { "type": "string", "enum": ["strict", "normalized", "semantic"] },
            "formatMismatch": { "type": "string", "enum": ["fail", "warn", "ignore"] }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "execution": {
      "type": "object",
      "properties": {
        "flowMode": { "type": "string", "enum": ["sequence", "parallel"] }
      },
      "additionalProperties": false
    },
    "pairGate": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "stopOnFirstMissionFailure": { "type": "boolean" },
        "traceProfile": { "type": "string", "enum": ["none", "strict_browser_comparison", "mcp_required"] }
      },
      "additionalProperties": false
    },
    "flowGate": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "stopOnFirstMissionFailure": { "type": "boolean" },
        "traceProfile": { "type": "string", "enum": ["none", "strict_browser_comparison", "mcp_required"] }
      },
      "additionalProperties": false
    },
    "semantic": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "rulesPath": { "type": "string" }
      },
      "additionalProperties": false
    },
    "noContext": {
      "type": "object",
      "properties": {
        "forbiddenPromptTerms": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "cleanup": {
      "type": "object",
      "properties": {
        "beforeMission": { "type": "array", "items": { "type": "string" } },
        "afterMission": { "type": "array", "items": { "type": "string" } },
        "onFailure": { "type": "array", "items": { "type": "string" } },
        "preMission": { "type": "array", "items": { "type": "string" } },
        "postMission": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "timeouts": {
      "type": "object",
      "properties": {
        "campaignGlobalTimeoutMs": { "type": "integer", "minimum": 0 },
        "defaultAttemptTimeoutMs": { "type": "integer", "minimum": 0 },
        "cleanupHookTimeoutMs": { "type": "integer", "minimum": 0 },
        "missionEnvelopeMs": { "type": "integer", "minimum": 0 },
        "watchdogHeartbeatMs": { "type": "integer", "minimum": 0 },
        "watchdogHardKillContinue": { "type": "boolean" },
        "timeoutStart": { "type": "string", "enum": ["attempt_start", "first_tool_call"] }
      },
      "additionalProperties": false
    },
    "output": {
      "type": "object",
      "properties": {
        "reportPath": { "type": "string" },
        "summaryPath": { "type": "string" },
        "resultsMdPath": { "type": "string" },
        "publishCheck": { "type": "string" },
        "progressJsonl": { "type": "string" }
      },
      "additionalProperties": false
    },
    "invalidRunPolicy": {
      "type": "object",
      "properties": {
        "statuses": { "type": "array", "items": { "type": "string" } },
        "publishRequiresValid": { "type": "boolean" },
        "forceFlag": { "type": "string" }
      },
      "additionalProperties": false
    },
    "flows": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["flowId", "runner"],
        "properties": {
          "flowId": { "type": "string", "minLength": 1 },
          "suiteFile": { "type": "string", "minLength": 1 },
          "promptSource": {
            "type": "object",
            "properties": {
              "path": { "type": "string" }
            },
            "additionalProperties": false
          },
          "promptTemplate": {
            "type": "object",
            "properties": {
              "path": { "type": "string" },
              "allowRunnerEnvKeys": { "type": "array", "items": { "type": "string" } }
            },
            "additionalProperties": false
          },
          "toolPolicy": {
            "type": "object",
            "properties": {
              "allow": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "namespace": { "type": "string" },
                    "prefix": { "type": "string" }
                  },
                  "additionalProperties": false
                }
              },
              "deny": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "namespace": { "type": "string" },
                    "prefix": { "type": "string" }
                  },
                  "additionalProperties": false
                }
              },
              "aliases": {
                "type": "object",
                "additionalProperties": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            },
            "additionalProperties": false
          },
          "runner": {
            "type": "object",
            "properties": {
              "type": { "type": "string", "enum": ["process_cmd", "codex_exec", "codex_subagent", "claude_subagent", "codex_app_server"] },
              "command": { "type": "array", "minItems": 1, "items": { "type": "string" } },
              "env": { "type": "object", "additionalProperties": { "type": "string" } },
              "shims": { "type": "array", "items": { "type": "string" } },
              "runtimeStrategies": { "type": "array", "items": { "type": "string" } },
              "model": { "type": "string", "minLength": 1 },
              "modelReasoningEffort": { "type": "string", "enum": ["none", "minimal", "low", "medium", "high", "xhigh"] },
              "modelReasoningPolicy": { "type": "string", "enum": ["best_effort", "required"] },
              "sessionIsolation": { "type": "string", "enum": ["auto", "process", "native"] },
              "feedbackPolicy": { "type": "string", "enum": ["strict", "auto_fail"] },
              "mode": { "type": "string", "enum": ["discovery", "ci"] },
              "timeoutMs": { "type": "integer", "minimum": 0 },
              "timeoutStart": { "type": "string", "enum": ["attempt_start", "first_tool_call"] },
              "strict": { "type": "boolean" },
              "strictExpect": { "type": "boolean" },
              "freshAgentPerAttempt": { "type": "boolean" },
              "toolDriver": {
                "type": "object",
                "properties": {
                  "kind": { "type": "string", "enum": ["shell", "cli_funnel", "mcp_proxy", "http_proxy"] },
                  "shims": { "type": "array", "items": { "type": "string" } }
                },
                "additionalProperties": false
              },
              "finalization": {
                "type": "object",
                "properties": {
                  "mode": { "type": "string", "enum": ["strict", "auto_fail", "auto_from_result_json"] },
                  "minResultTurn": { "type": "integer", "minimum": 0 },
                  "resultChannel": {
                    "type": "object",
                    "properties": {
                      "kind": { "type": "string", "enum": ["none", "file_json", "stdout_json"] },
                      "path": { "type": "string" },
                      "marker": { "type": "string" }
                    },
                    "additionalProperties": false
                  }
                },
                "additionalProperties": false
              },
              "mcp": {
                "type": "object",
                "properties": {
                  "maxToolCalls": { "type": "integer", "minimum": 0 },
                  "idleTimeoutMs": { "type": "integer", "minimum": 0 },
                  "shutdownOnComplete": { "type": "boolean" }
                },
                "additionalProperties": false
              }
            },
            "additionalProperties": false
          },
          "adapterContract": {
            "type": "object",
            "properties": {
              "requiredOutputFields": {
                "type": "array",
                "items": { "type": "string" }
              }
            },
            "additionalProperties": false
          }
        },
        "additionalProperties": false
      }
    }
  },
  "patternProperties": {
    "^x-": true
  },
  "additionalProperties": false
}
